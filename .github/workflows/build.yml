name: Build

on:
  push:
    branches:
      - "**"
    tags-ignore:
      - "*.*"
  pull_request:
    branches:
      - "**"

jobs:
  prebuild:
    name: Prebuild (N-API) on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-13
          - ubuntu-22.04
          - windows-2022

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Yarn Berry
        run: |
          corepack enable
          yarn set version berry

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ github.ref }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-${{ github.ref }}-
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build N-API prebuilds
        run: yarn prebuild

      # TODO: optionally upload the prebuilds as an artifact if you want to
      # gate publishing on CI or aggregate from multiple jobs.

  prebuild_musl:
    name: Prebuild (linux-musl) with Node ${{ matrix.node }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        node: [22] # you can add more if you really want, but N-API means one is enough

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: true

      - name: Build musl prebuilds in Alpine
        run: |
          mkdir -p .tmp
          docker run --rm \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            -e TMPDIR=/work/.tmp \
            node:${{ matrix.node }}-alpine \
            sh -lc '
              set -euo pipefail
              apk add --no-cache python3 make g++ &&
              corepack enable &&
              yarn install --immutable --unsafe-perm &&
              # Build N-API prebuilds for musl, tagging libc so node-gyp-build
              # can prefer them on Alpine.
              yarn prebuild
            '
